<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Studio | Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            // Hi! Replace 'YOUR_PUBLIC_KEY' with your actual EmailJS Public Key from the dashboard.
            // https://dashboard.emailjs.com/admin/account
            emailjs.init("YVVauE5uaG-7fu5Wi");
        })();
    </script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin Specific Styles Override/Addon */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 20px;
        }

        .dashboard-stats {
            display: flex;
            gap: 20px;
        }

        .stat-card {
            background: var(--color-surface);
            padding: 15px 25px;
            border: 1px solid var(--color-border);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
        }

        /* Create Form */
        .create-project-card {
            background: var(--color-surface);
            padding: 30px;
            border: 1px solid var(--color-border);
            margin-bottom: 40px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 20px;
            align-items: end;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        input[type="email"] {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 10px;
            font-family: inherit;
        }

        input:focus {
            border-color: var(--color-text);
            outline: none;
        }

        /* Project Table */
        .project-table {
            width: 100%;
            border-collapse: collapse;
        }

        .project-table th {
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-muted);
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .project-table td {
            padding: 15px;
            border-bottom: 1px solid #222;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: bold;
        }

        .status-selection {
            background: #333;
            color: #fff;
        }

        .status-processing {
            background: #ffaa00;
            color: #000;
        }

        .status-completed {
            background: #00ff88;
            color: #000;
        }

        .action-link {
            color: var(--color-text-muted);
            text-decoration: none;
            margin-right: 15px;
            font-size: 0.9rem;
        }

        .action-link:hover {
            color: var(--color-text);
            text-decoration: underline;
        }

        .btn-action {
            background: var(--color-text);
            color: var(--color-bg);
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }

        /* Gallery Grid View */
        .gallery-grid {
            display: grid;
            /* Enforce exactly 4 columns on large screens */
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .gallery-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .gallery-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .gallery-grid {
                grid-template-columns: 1fr;
            }
        }

        .gallery-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .gallery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .gallery-preview {
            height: 180px;
            background: #222;
            width: 100%;
            object-fit: cover;
        }

        .gallery-info {
            padding: 15px;
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .gallery-title {
            font-weight: 600;
            font-size: 1rem;
            margin: 0;
            color: var(--color-text);
        }

        .gallery-date {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .gallery-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-select {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 4px;
        }

        /* Fix scrolling for Admin Page */
        body {
            overflow: auto !important;
            height: auto !important;
        }
    </style>
</head>

<body>

    <div class="admin-container">

        <header class="dashboard-header">
            <h1>Select Studio Cloud <span style="font-weight:300; opacity:0.5;">| Admin</span></h1>
        </header>

        <!-- Create Project -->
        <section class="create-project-card">
            <h2 style="margin-bottom: 20px; font-weight: 400;">Neuer Auftrag (Upload)</h2>

            <!-- File Upload Zone -->
            <div id="drop-zone" class="upload-zone"
                style="border: 2px dashed var(--color-border); padding: 40px; text-align: center; margin-bottom: 30px; cursor: pointer; transition: all 0.2s;">
                <div style="font-size: 2rem; margin-bottom: 10px;">‚òÅÔ∏è</div>
                <p style="color: var(--color-text-muted);">Bilder hier ablegen oder klicken</p>
                <input type="file" id="file-input" multiple accept="image/*" style="display: none;">
                <div id="preview-area" class="preview-grid"></div>
            </div>

            <form id="create-project-form">
                <div class="input-group">
                    <label class="label-small">Kunden E-Mail</label>
                    <input type="email" id="client-email" placeholder="kunde@example.com" required>
                </div>

                <div class="input-group">
                    <label class="label-small">Paket Gr√∂√üe</label>
                    <select id="package-size" class="filter-select" style="width: 100%;">
                        <option value="5">Small (5 Bilder)</option>
                        <option value="12" selected>Medium (12 Bilder)</option>
                        <option value="20">Large (20 Bilder)</option>
                        <option value="50">Jumbo (50 Bilder)</option>
                    </select>
                </div>

                <button type="submit" id="btn-create" class="btn-primary"
                    style="width: auto; min-width: 150px;">GALLERIE ERSTELLEN & MAIL SENDEN</button>
            </form>
        </section>

        <!-- Project Galleries -->
        <section class="create-project-card"> <!-- Wrapped in Card for Padding & Width Alignment -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-weight: 400; margin: 0;">Meine Gallerien</h2>

                <!-- Moved Stats Here -->
                <div class="dashboard-stats" style="gap:10px;">
                    <div class="stat-card"
                        style="padding: 8px 16px; background: transparent; border: 1px solid var(--color-border); display:flex; flex-direction:column; align-items:center;">
                        <span class="stat-number" id="total-projects" style="line-height:1;">0</span>
                        <span class="stat-label" style="font-size:0.6rem;">Projekte</span>
                    </div>
                </div>
            </div>

            <div class="filter-bar">
                <input type="text" id="filter-search" placeholder="Suche nach E-Mail..."
                    style="background: var(--color-surface); border: 1px solid var(--color-border); padding: 8px; color: white;">

                <select id="filter-status" class="filter-select">
                    <option value="ALL">Alle Status</option>
                    <option value="SELECTION">Auswahl offen</option>
                    <option value="PROCESSING">In Bearbeitung</option>
                    <option value="COMPLETED">Abgeschlossen</option>
                </select>

                <select id="sort-by" class="filter-select">
                    <option value="date-desc">Neueste zuerst</option>
                    <option value="date-asc">√Ñlteste zuerst</option>
                    <option value="email-asc">E-Mail (A-Z)</option>
                </select>
            </div>

            <div id="gallery-grid" class="gallery-grid">
                <!-- Injected via JS -->
            </div>

            <p id="empty-msg" style="text-align: center; color: #666; display: none; margin-top: 40px;">
                Keine Gallerien gefunden.
            </p>
        </section>

        <!-- Project Detail Modal -->
        <div id="detail-modal" class="modal-overlay" hidden
            style="background: rgba(0,0,0,0.8); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div class="modal-content"
                style="background: var(--color-surface); padding: 30px; border: 1px solid var(--color-border); max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                <button id="close-detail"
                    style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #fff; font-size: 2rem; cursor: pointer;">&times;</button>

                <h2 id="detail-title" style="margin-bottom: 20px;">Projekt Details</h2>

                <div
                    style="margin-bottom: 30px; display: flex; gap: 40px; border-bottom: 1px solid #333; padding-bottom: 20px;">
                    <div>
                        <span class="label-small">Kunde</span><br>
                        <span id="detail-email" style="font-size: 1.2rem;">-</span>
                    </div>
                    <div>
                        <span class="label-small">Paket</span><br>
                        <span id="detail-package">-</span>
                    </div>
                    <div>
                        <span class="label-small">Status</span><br>
                        <span id="detail-status">-</span>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;">Ausgew√§hlte Bilder</h3>
                <div id="detail-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    <!-- Selections Injected Here -->
                </div>

                <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                    <h3 style="margin-bottom: 10px;">Finale Bilder hochladen</h3>
                    <p class="label-small" style="margin-bottom: 15px;">Lade die retuschierten Bilder hier hoch, um das
                        Projekt abzuschlie√üen und den Kunden zu benachrichtigen.</p>

                    <div id="finals-drop-zone"
                        style="border: 2px dashed #444; padding: 20px; text-align: center; margin-bottom: 20px; cursor: pointer;">
                        <span style="font-size: 1.5rem;">‚ú®</span><br>
                        <span style="color: #888;">Finale Bilder hier ablegen</span>
                        <input type="file" id="finals-input" multiple accept="image/*" style="display: none;">
                    </div>
                    <div id="finals-preview"
                        style="display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px; height: 60px;"></div>

                    <div style="text-align: right; display:flex; justify-content:space-between; align-items:center;">
                        <button id="btn-delete-project" class="btn-text"
                            style="color:var(--color-danger); font-size:0.8rem;">PROJEKT L√ñSCHEN</button>

                        <button id="btn-complete-project" class="btn-primary" disabled style="width:auto;">Bilder
                            hochladen &
                            Abschlie√üen</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase Compat SDKs (Safe for file:// usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Services -->
    <script src="services.js"></script>
    <script>
        // Check Auth immediately
        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                // Show user email in header maybe?
                console.log("Logged in as:", user.email);
            }
        });

        // Inline Admin Logic (Simple enough to keep here or move to admin.js)
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('create-project-form');
            const listBody = null; // Removed table body reference
            const statTotal = document.getElementById('total-projects');

            // Add Logout Button Logic
            const header = document.querySelector('.dashboard-header');
            const logoutBtn = document.createElement('button');
            logoutBtn.textContent = 'ABMELDEN';
            logoutBtn.className = 'btn-secondary';
            logoutBtn.style.fontSize = '0.8rem';
            logoutBtn.style.marginLeft = '20px';
            logoutBtn.onclick = () => window.selectService.logout();
            header.appendChild(logoutBtn);

            // Upload Logic
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const previewArea = document.getElementById('preview-area');
            let selectedFiles = [];

            // Drag & Drop
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#fff'; });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#333'; });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#333';
                handleFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            function handleFiles(files) {
                selectedFiles = Array.from(files);
                previewArea.innerHTML = '';

                if (selectedFiles.length === 0) return;

                const grid = document.createElement('div');
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(80px, 1fr))';
                grid.style.gap = '10px';
                grid.style.marginTop = '20px';

                selectedFiles.slice(0, 10).forEach(file => { // Show max 10 preview
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.style.width = '100%';
                    img.style.aspectRatio = '1';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '4px';
                    grid.appendChild(img);
                });

                if (selectedFiles.length > 10) {
                    const more = document.createElement('div');
                    more.textContent = `+${selectedFiles.length - 10} mehr`;
                    more.style.display = 'flex';
                    more.style.alignItems = 'center';
                    more.style.justifyContent = 'center';
                    more.style.fontSize = '0.8rem';
                    more.style.color = '#888';
                    grid.appendChild(more);
                }

                previewArea.appendChild(grid);
            }

            // Render List
            // Render List
            async function refreshList() {
                const projects = await window.selectService.getAllProjects();
                statTotal.textContent = projects.length;
                renderGalleryGrid(projects);
            }

            function renderGalleryGrid(projects) {
                const grid = document.getElementById('gallery-grid');
                if (!grid) {
                    console.error("Gallery Grid Element not found!");
                    return;
                }

                const emptyMsg = document.getElementById('empty-msg');
                const filterSearch = document.getElementById('filter-search').value.toLowerCase();
                const filterStatus = document.getElementById('filter-status').value;
                const sortBy = document.getElementById('sort-by').value;

                console.log("Rendering Grid with", projects.length, "projects");

                // Filter
                let filtered = projects.filter(p => {
                    const status = p.status || 'UNKNOWN';
                    const email = p.email || '';
                    if (filterStatus !== 'ALL' && status !== filterStatus) return false;
                    if (filterSearch && !email.toLowerCase().includes(filterSearch)) return false;
                    return true;
                });

                // Sort
                filtered.sort((a, b) => {
                    const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                    const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                    const emailA = a.email || '';
                    const emailB = b.email || '';

                    if (sortBy === 'date-desc') return dateB - dateA;
                    if (sortBy === 'date-asc') return dateA - dateB;
                    if (sortBy === 'email-asc') return emailA.localeCompare(emailB);
                    return 0;
                });

                grid.innerHTML = '';

                if (filtered.length === 0) {
                    if (emptyMsg) emptyMsg.style.display = 'block';
                    grid.style.display = 'none';
                    return;
                }

                if (emptyMsg) emptyMsg.style.display = 'none';
                grid.style.display = 'grid'; // Ensure grid display

                filtered.forEach(p => {
                    const date = p.createdAt ? new Date(p.createdAt).toLocaleDateString('de-DE') : 'Kein Datum';
                    const status = p.status || 'UNKNOWN';
                    const email = p.email || 'Keine E-Mail';

                    let badgeClass = 'status-selection';
                    if (status === 'PROCESSING') badgeClass = 'status-processing';
                    if (status === 'COMPLETED') badgeClass = 'status-completed';

                    // Use first asset as preview
                    const previewUrl = (p.assets && p.assets.length > 0) ? p.assets[0].url : 'https://placehold.co/400x300?text=No+Image';

                    const card = document.createElement('div');
                    card.className = 'gallery-card';
                    card.style.cursor = 'pointer';

                    // Click handler
                    card.onclick = (e) => {
                        if (e.target.closest('button') || e.target.closest('a')) return;
                        openDetailModal(p.id);
                    };

                    card.innerHTML = `
                        <div style="position:relative; aspect-ratio: 3/2; overflow:hidden;">
                            <img src="${previewUrl}" class="gallery-preview" style="width:100%; height:100%; object-fit:cover;">
                            <div style="position:absolute; top:10px; right:10px;">
                                <span class="status-badge ${badgeClass}">${status}</span>
                            </div>
                        </div>
                        <div class="gallery-info" style="padding:15px;">
                            <div class="gallery-header" style="margin-bottom:10px;">
                                <h3 class="gallery-title" style="margin:0; font-size:1.1rem;">${email}</h3>
                                <span class="gallery-date" style="font-size:0.8rem; color:#888;">${date}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 15px;">
                                <span>üì¶ ${p.packageSize || '-'} Bilder</span> ‚Ä¢ 
                                <span>üñºÔ∏è ${p.assets ? p.assets.length : 0} Uploads</span>
                            </div>
                            
                            <div class="gallery-footer" style="display:flex; gap:10px;">
                                <button class="btn-secondary" style="width:auto; font-size:0.8rem; padding:4px 8px;" onclick="openDetailModal('${p.id}')">Bearbeiten</button>
                                <a href="customer.html?projectId=${p.id}" target="_blank" class="btn-primary" style="width:auto; font-size:0.8rem; padding:4px 8px; text-decoration:none; text-align:center;">Galerie ansehen ‚Üó</a>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            // Filter Event Listeners
            const fSearch = document.getElementById('filter-search');
            if (fSearch) fSearch.addEventListener('input', refreshList);

            const fStatus = document.getElementById('filter-status');
            if (fStatus) fStatus.addEventListener('change', refreshList);

            const fSort = document.getElementById('sort-by');
            if (fSort) fSort.addEventListener('change', refreshList);


            // Modal Logic
            const detailModal = document.getElementById('detail-modal');
            const closeDetail = document.getElementById('close-detail');
            const btnComplete = document.getElementById('btn-complete-project');
            let currentDetailProject = null;

            closeDetail.addEventListener('click', () => detailModal.hidden = true);
            detailModal.addEventListener('click', (e) => { if (e.target === detailModal) detailModal.hidden = true; });

            window.openDetailModal = async (projectId) => {
                try {
                    const project = await window.selectService.getProject(projectId);
                    currentDetailProject = project;

                    document.getElementById('detail-title').textContent = `Projekt: ${project.id.split('-')[0]}`; // Short ID
                    document.getElementById('detail-email').textContent = project.email;
                    document.getElementById('detail-package').textContent = `${project.packageSize} Bilder`;
                    document.getElementById('detail-status').textContent = project.status;

                    // Render Grid
                    const grid = document.getElementById('detail-grid');
                    grid.innerHTML = '';

                    if (!project.selections || Object.keys(project.selections).length === 0) {
                        grid.innerHTML = '<p style="color: #666;">Noch keine Auswahl getroffen.</p>';
                    } else {
                        // We need to find the asset URL for each selection ID
                        // project.assets contains all images
                        const selectionIds = Object.keys(project.selections);

                        selectionIds.forEach(selId => {
                            const asset = project.assets.find(a => a.id === selId);
                            const options = project.selections[selId];

                            const card = document.createElement('div');
                            card.style.background = '#222';
                            card.style.padding = '10px';
                            card.style.borderRadius = '4px';

                            // Image
                            if (asset) {
                                const img = document.createElement('img');
                                img.src = asset.url;
                                img.style.width = '100%';
                                img.style.aspectRatio = '2/3';
                                img.style.objectFit = 'cover';
                                img.style.marginBottom = '10px';
                                card.appendChild(img);
                            }

                            // ID
                            const idLabel = document.createElement('div');
                            idLabel.textContent = selId;
                            idLabel.style.fontWeight = 'bold';
                            idLabel.style.marginBottom = '5px';
                            card.appendChild(idLabel);

                            // Options
                            if (options && options.length > 0) {
                                options.forEach(opt => {
                                    const tag = document.createElement('span');
                                    tag.textContent = opt;
                                    tag.style.display = 'inline-block';
                                    tag.style.background = '#444';
                                    tag.style.padding = '2px 6px';
                                    tag.style.fontSize = '0.75rem';
                                    tag.style.margin = '2px';
                                    tag.style.borderRadius = '2px';
                                    card.appendChild(tag);
                                });
                            } else {
                                const none = document.createElement('div');
                                none.textContent = 'Keine Retusche';
                                none.style.fontSize = '0.8rem';
                                none.style.color = '#666';
                                card.appendChild(none);
                            }

                            grid.appendChild(card);
                        });
                    }

                    // Finals Upload Logic
                    const finalsDrop = document.getElementById('finals-drop-zone');
                    const finalsInput = document.getElementById('finals-input');
                    const finalsPreview = document.getElementById('finals-preview');
                    let finalFiles = [];

                    // Reset
                    finalFiles = [];
                    finalsPreview.innerHTML = '';
                    btnComplete.disabled = true;
                    btnComplete.textContent = 'Bilder hochladen & Abschlie√üen';

                    // Delete Handler (Available for all statuses)
                    const btnDelete = document.getElementById('btn-delete-project');
                    if (btnDelete) {
                        btnDelete.onclick = async () => {
                            const confirmText = prompt(`M√∂chtest du das Projekt ${project.email} wirklich unwiderruflich L√ñSCHEN?\n\nTippe "L√ñSCHEN" zur Best√§tigung:`);
                            if (confirmText === 'L√ñSCHEN') {
                                try {
                                    await window.selectService.deleteProject(project.id);
                                    alert('Projekt gel√∂scht.');
                                    detailModal.hidden = true;
                                    refreshList();
                                } catch (e) {
                                    alert('Fehler beim L√∂schen: ' + e.message);
                                }
                            }
                        };
                    }

                    if (project.status === 'COMPLETED') {
                        finalsDrop.style.display = 'none';
                        btnComplete.disabled = true;
                        btnComplete.textContent = 'Projekt Abgeschlossen';
                    } else {
                        finalsDrop.style.display = 'block';

                        // Handlers
                        finalsDrop.onclick = () => finalsInput.click();
                        finalsInput.onchange = (e) => handleFinals(e.target.files);

                        finalsDrop.ondragover = (e) => { e.preventDefault(); finalsDrop.style.borderColor = '#fff'; };
                        finalsDrop.ondragleave = (e) => { e.preventDefault(); finalsDrop.style.borderColor = '#444'; };
                        finalsDrop.ondrop = (e) => {
                            e.preventDefault();
                            finalsDrop.style.borderColor = '#444';
                            handleFinals(e.dataTransfer.files);
                        };

                        function handleFinals(files) {
                            if (files.length === 0) return;
                            finalFiles = Array.from(files);

                            finalsPreview.innerHTML = '';
                            finalFiles.forEach(f => {
                                const img = document.createElement('img');
                                img.src = URL.createObjectURL(f);
                                img.style.height = '100%';
                                img.style.width = 'auto';
                                img.style.borderRadius = '4px';
                                finalsPreview.appendChild(img);
                            });

                            btnComplete.disabled = false;
                            btnComplete.textContent = `Abschlie√üen (${finalFiles.length} Bilder senden)`;
                        }

                        btnComplete.onclick = async () => {
                            if (confirm('Bilder hochladen und Projekt abschlie√üen? Der Kunde erh√§lt den Download-Link.')) {
                                try {
                                    btnComplete.disabled = true;
                                    btnComplete.textContent = 'Uploading...';

                                    await window.selectService.completeProjectWithFinals(project.id, finalFiles);

                                    alert('Erfolg! Projekt abgeschlossen.');
                                    detailModal.hidden = true;
                                    refreshList();
                                } catch (err) {
                                    alert('Fehler: ' + err.message);
                                    btnComplete.disabled = false;
                                }
                            }
                        };
                    }

                    detailModal.hidden = false;
                    detailModal.style.display = 'flex'; // Restore flex for centering

                } catch (e) {
                    alert('Fehler beim Laden: ' + e.message);
                }
            };

            // Create Handler
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-create');
                btn.disabled = true;
                btn.textContent = 'UPLOADING TO CLOUD...';

                try {
                    const email = document.getElementById('client-email').value;

                    // Simulate Network Delay for Upload
                    await new Promise(r => setTimeout(r, 500));

                    if (selectedFiles.length === 0) {
                        if (!confirm("Keine Bilder ausgew√§hlt. Leere Galerie erstellen?")) return;
                    }

                    const packageSize = document.getElementById('package-size').value;

                    await window.selectService.createProject(email, packageSize, selectedFiles);

                    form.reset();
                    selectedFiles = [];
                    previewArea.textContent = '';
                    // Successful alert handled in service

                    refreshList();
                } catch (err) {
                    alert('Fehler: ' + err.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'PROJEKT ERSTELLEN & MAIL SENDEN';
                }
            });

            // Global Resend Function
            window.resendMail = async (projectId) => {
                try {
                    const project = await window.selectService.getProject(projectId);
                    if (confirm(`E-Mail an ${project.email} erneut senden?`)) {
                        await window.selectService.sendMail('UPLOAD_READY', project);
                    }
                } catch (e) {
                    alert('Fehler: ' + e.message);
                }
            };

            // Force Refresh on Load with explicit logging
            console.log("Admin Loaded. Refreshing list...");
            try {
                await refreshList();
                console.log("List Refreshed.");

                // New: Check for Deep Link (e.g. from Email)
                const urlParams = new URLSearchParams(window.location.search);
                const deepLinkProjectId = urlParams.get('projectId');
                if (deepLinkProjectId) {
                    console.log("Opening Deep Link Project:", deepLinkProjectId);
                    // Use small timeout to ensure DOM is ready? Not needed since we awaited refreshList
                    window.openDetailModal(deepLinkProjectId);

                    // Optional: Clear URL so refresh doesn't reopen it
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

            } catch (error) {
                console.error("Fatal Error refreshing list:", error);
                document.getElementById('gallery-grid').innerHTML = `<p style="color:red; text-align:center;">Fehler beim Laden: ${error.message}</p>`;
            }
        });
    </script>
</body>

</html>